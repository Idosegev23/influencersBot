# ğŸ” ××¢×¨×›×ª ×”×¨×©××•×ª - Influencer OS

## ×¡×§×™×¨×”
××¢×¨×›×ª ×”×¨×©××•×ª ×¨×‘-×©×›×‘×ª×™×ª ×¢× 4 ×¨××•×ª ×’×™×©×”.

---

## ğŸ‘¥ 4 ×¨××•×ª ××©×ª××©×™×

### 1. ğŸ”´ Admin (×× ×”×œ ××¢×¨×›×ª)
**×’×™×©×”:** ×”×›×œ ×œ×œ× ×”×’×‘×œ×”

**×™×›×•×œ×•×ª:**
- âœ… ×¨×•××” ××ª ×›×œ ×”××©×¤×™×¢× ×™× ×•×”××•×ª×’×™×
- âœ… ×¨×•××” ××ª ×›×œ ×”×©×ª"×¤×™×, ××©×™××•×ª, ×—×©×‘×•× ×™×•×ª
- âœ… ×’×™×©×” ×œ×›×œ ×”-analytics
- âœ… × ×™×”×•×œ ××©×ª××©×™× (×”×•×¡×¤×”, ×”×¡×¨×”, ×©×™× ×•×™ ×ª×¤×§×™×“×™×)
- âœ… ×’×™×©×” ×œ××¡×š × ×™×”×•×œ (Admin Dashboard)
- âœ… ×¦×¤×™×™×” ×‘-audit logs
- âœ… × ×™×”×•×œ ×”×¨×©××•×ª
- âœ… ×’×™×©×” ×œ×›×œ ×”-APIs ×œ×œ× ×”×’×‘×œ×”

**×“×•×’×××•×ª ×©×™××•×©:**
- ×‘×¢×œ ×”×¢×¡×§
- CTO / ×× ×”×œ ×˜×›× ×™
- Support ×‘×¨××” ×”×›×™ ×’×‘×•×”×”

---

### 2. ğŸŸ  Agent (×¡×•×›×Ÿ)
**×’×™×©×”:** ×¨×§ ×œ××©×¤×™×¢× ×™× ×©×”×•× ×× ×”×œ

**×™×›×•×œ×•×ª:**
- âœ… ×¨×•××” ×¨×©×™××ª ×”××©×¤×™×¢× ×™× ×©×œ×• ×‘×œ×‘×“
- âœ… ×¨×•××” dashboard ×©×œ ×›×œ ××©×¤×™×¢×Ÿ ×ª×—×ª×™×•
- âœ… ×¨×•××” ×©×ª"×¤×™×, ××©×™××•×ª, ×—×©×‘×•× ×™×•×ª ×©×œ ×”××©×¤×™×¢× ×™× ×©×œ×•
- âœ… analytics ××¦×˜×‘×¨ ×©×œ ×”××©×¤×™×¢× ×™× ×©×œ×•
- âœ… ×™×›×•×œ ×œ×¢×‘×•×¨ ×‘×™×Ÿ ××©×¤×™×¢× ×™× ×©×œ×•
- âŒ ×œ× ×¨×•××” ××©×¤×™×¢× ×™× ×©×œ ×¡×•×›× ×™× ××—×¨×™×
- âŒ ×œ× ×¨×•××” Admin Dashboard
- âŒ ×œ× ×™×›×•×œ ×œ×©× ×•×ª ×”×¨×©××•×ª

**×“×•×’×××•×ª ×©×™××•×©:**
- ×× ×”×œ ×—×©×‘×•× ×•×ª
- Account manager
- Talent manager

**××‘× ×” ×”×™×¨×¨×›×™:**
```
Agent A
  â”œâ”€â”€ Influencer 1
  â”œâ”€â”€ Influencer 2
  â””â”€â”€ Influencer 3

Agent B
  â”œâ”€â”€ Influencer 4
  â””â”€â”€ Influencer 5
```

---

### 3. ğŸŸ¢ Influencer / Brand (××©×¤×™×¢×Ÿ / ××•×ª×’)
**×’×™×©×”:** ×¨×§ ×œ××™×“×¢ ×©×œ×•

**×™×›×•×œ×•×ª:**
- âœ… ×¨×•××” ×¨×§ ××ª ×”×“×©×‘×•×¨×“ ×©×œ×•
- âœ… ×¨×•××” ××ª ×”×©×ª"×¤×™× ×©×œ×• ×‘×œ×‘×“
- âœ… ×¨×•××” ××ª ×”××©×™××•×ª ×©×œ×•
- âœ… ×¨×•××” ××ª ×”×—×©×‘×•× ×™×•×ª ×©×œ×•
- âœ… analytics ×©×œ ×”×¦'××˜×‘×•×˜ ×©×œ×•
- âœ… ××•×ª×’×™× ×•×§×•×¤×•× ×™× ×©×œ×•
- âœ… ×©×™×—×•×ª ×©×œ ×”××©×ª××©×™× ××™×ª×•
- âŒ ×œ× ×¨×•××” ××©×¤×™×¢× ×™×/××•×ª×’×™× ××—×¨×™×
- âŒ ×œ× ×¨×•××” × ×ª×•× ×™× ×©×œ ××—×¨×™×

**×“×•×’×××•×ª ×©×™××•×©:**
- ×”××©×¤×™×¢×Ÿ ×¢×¦××•
- ×”××•×ª×’ ×¢×¦××•
- ×”×¢×•×–×¨ ×”××™×©×™ ×©×œ ×”××©×¤×™×¢×Ÿ

---

### 4. ğŸ”µ Follower (×¢×•×§×‘ / ××©×ª××© ×¨×’×™×œ)
**×’×™×©×”:** ×¨×§ ×œ×¦'××˜×‘×•×˜ ×¦×™×‘×•×¨×™

**×™×›×•×œ×•×ª:**
- âœ… ×’×™×©×” ×œ×¦'××˜×‘×•×˜ ×©×œ ×”××©×¤×™×¢×Ÿ
- âœ… ×¨×•××” ××•×ª×’×™× ×•×§×•×¤×•× ×™× ×¦×™×‘×•×¨×™×™×
- âœ… ×¨×•××” ×ª×•×›×Ÿ ×©×™×•×•×§×™
- âœ… ×™×›×•×œ ×œ×¤×ª×•×— ×¤× ×™×•×ª ×ª××™×›×”
- âŒ ×œ× ×¨×•××” dashboard
- âŒ ×œ× ×¨×•××” ×©×ª"×¤×™×
- âŒ ×œ× ×¨×•××” ××©×™××•×ª
- âŒ ×œ× ×¨×•××” ×—×©×‘×•× ×™×•×ª
- âŒ ×œ× ×¨×•××” analytics

**×“×•×’×××•×ª ×©×™××•×©:**
- ×¢×•×§×‘ ×‘××™× ×¡×˜×’×¨×
- ××‘×§×¨ ×‘××ª×¨
- ××©×ª××© ×‘×¦'××˜×‘×•×˜

---

## ğŸ—„ï¸ Database Schema ×œ×”×¨×©××•×ª

### ×˜×‘×œ×ª `users` (×—×“×©×”):
```sql
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  email VARCHAR(255) UNIQUE NOT NULL,
  full_name VARCHAR(255),
  role VARCHAR(20) NOT NULL CHECK (role IN ('admin', 'agent', 'influencer', 'brand', 'follower')),
  
  -- For agents: which influencers they manage
  managed_account_ids UUID[], -- Array of account IDs
  
  -- For influencers/brands: their account
  account_id UUID REFERENCES accounts(id),
  
  -- Auth
  password_hash VARCHAR(255), -- ××• Supabase Auth
  last_login TIMESTAMPTZ,
  
  -- Status
  status VARCHAR(20) DEFAULT 'active' CHECK (status IN ('active', 'suspended', 'deleted')),
  
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_users_role ON users(role);
CREATE INDEX idx_users_account_id ON users(account_id);
CREATE INDEX idx_users_email ON users(email);
```

### ×˜×‘×œ×ª `role_permissions` (××•×¤×¦×™×•× ×œ×™):
```sql
CREATE TABLE role_permissions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  role VARCHAR(20) NOT NULL,
  resource VARCHAR(50) NOT NULL, -- 'partnerships', 'tasks', 'analytics'
  action VARCHAR(20) NOT NULL, -- 'view', 'create', 'update', 'delete'
  allowed BOOLEAN DEFAULT true,
  
  UNIQUE(role, resource, action)
);
```

---

## ğŸ”’ RLS Policies ×œ×¤×™ ×ª×¤×§×™×“

### ×“×•×’××”: Partnerships

```sql
-- Admin: ×¨×•××” ×”×›×œ
CREATE POLICY "Admin can view all partnerships"
  ON partnerships FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM users 
      WHERE users.id = auth.uid() 
      AND users.role = 'admin'
    )
  );

-- Agent: ×¨×•××” ×¨×§ ××©×¤×™×¢× ×™× ×©×œ×•
CREATE POLICY "Agent can view managed partnerships"
  ON partnerships FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM users 
      WHERE users.id = auth.uid() 
      AND users.role = 'agent'
      AND partnerships.account_id = ANY(users.managed_account_ids)
    )
  );

-- Influencer/Brand: ×¨×•××” ×¨×§ ×©×œ×•
CREATE POLICY "Influencer can view own partnerships"
  ON partnerships FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM users 
      WHERE users.id = auth.uid() 
      AND users.role IN ('influencer', 'brand')
      AND partnerships.account_id = users.account_id
    )
  );

-- Follower: ×œ× ×¨×•××” ×‘×›×œ×œ
-- (no policy = no access)
```

---

## ğŸ›£ï¸ Route Protection

### API Middleware:
```typescript
// src/middleware/auth.ts
export async function checkPermission(
  userId: string,
  resource: string,
  action: string,
  resourceAccountId?: string
): Promise<{ allowed: boolean; reason?: string }> {
  
  const user = await getUser(userId);
  
  // Admin: always allowed
  if (user.role === 'admin') {
    return { allowed: true };
  }
  
  // Agent: only if managing this account
  if (user.role === 'agent') {
    if (!resourceAccountId) return { allowed: false, reason: 'No account specified' };
    
    const isManaging = user.managed_account_ids?.includes(resourceAccountId);
    return { 
      allowed: isManaging,
      reason: isManaging ? undefined : 'Account not managed by this agent'
    };
  }
  
  // Influencer/Brand: only their own
  if (user.role === 'influencer' || user.role === 'brand') {
    if (user.account_id !== resourceAccountId) {
      return { allowed: false, reason: 'Can only access own data' };
    }
    return { allowed: true };
  }
  
  // Follower: no access to management resources
  if (user.role === 'follower') {
    return { allowed: false, reason: 'Followers cannot access management features' };
  }
  
  return { allowed: false, reason: 'Unknown role' };
}
```

### Frontend Route Guard:
```typescript
// src/components/RouteGuard.tsx
export function RouteGuard({ 
  children, 
  requiredRole,
  accountId 
}: { 
  children: React.ReactNode;
  requiredRole?: Role[];
  accountId?: string;
}) {
  const { user } = useAuth();
  
  // Check role
  if (requiredRole && !requiredRole.includes(user.role)) {
    return <AccessDenied />;
  }
  
  // Check account access (for agents/influencers)
  if (accountId && user.role === 'agent') {
    if (!user.managed_account_ids?.includes(accountId)) {
      return <AccessDenied />;
    }
  }
  
  if (accountId && (user.role === 'influencer' || user.role === 'brand')) {
    if (user.account_id !== accountId) {
      return <AccessDenied />;
    }
  }
  
  return <>{children}</>;
}
```

---

## ğŸ“± UI ×œ×¤×™ ×ª×¤×§×™×“

### Sidebar Navigation:

#### Admin:
```
â”œâ”€â”€ ğŸ  Overview (×›×œ ×”××©×¤×™×¢× ×™×)
â”œâ”€â”€ ğŸ‘¥ Users & Permissions
â”œâ”€â”€ ğŸ“Š All Partnerships
â”œâ”€â”€ âœ… All Tasks
â”œâ”€â”€ ğŸ’° All Invoices
â”œâ”€â”€ ğŸ“ˆ Global Analytics
â””â”€â”€ âš™ï¸ Settings
```

#### Agent:
```
â”œâ”€â”€ ğŸ  My Influencers
â”œâ”€â”€ ğŸ“Š Partnerships (filtered)
â”œâ”€â”€ âœ… Tasks (filtered)
â”œâ”€â”€ ğŸ’° Invoices (filtered)
â”œâ”€â”€ ğŸ“ˆ Team Analytics
â””â”€â”€ âš™ï¸ My Settings
```

#### Influencer/Brand:
```
â”œâ”€â”€ ğŸ  Dashboard
â”œâ”€â”€ ğŸ“Š My Partnerships
â”œâ”€â”€ âœ… My Tasks
â”œâ”€â”€ ğŸ’° My Invoices
â”œâ”€â”€ ğŸ“… Calendar
â”œâ”€â”€ ğŸ“ˆ My Analytics
â””â”€â”€ âš™ï¸ Settings
```

#### Follower:
```
â”œâ”€â”€ ğŸ’¬ Chat
â””â”€â”€ (no dashboard access)
```

---

## ğŸ¨ UI Components ×œ×¤×™ ×”×¨×©××”

### AccountSelector (×œAdmin/Agent):
```tsx
// Admin ×¨×•××” dropdown ×©×œ ×›×œ ×”×—×©×‘×•× ×•×ª
// Agent ×¨×•××” dropdown ×¨×§ ×©×œ ×”××©×¤×™×¢× ×™× ×©×œ×•
// Influencer/Brand ×œ× ×¨×•××” selector (×¨×§ ×©×œ×•)

{user.role === 'admin' || user.role === 'agent' ? (
  <AccountSelector 
    accounts={availableAccounts}
    onChange={setSelectedAccount}
  />
) : null}
```

### DataTable ×¢× Permission Checks:
```tsx
<DataTable
  data={partnerships}
  canEdit={user.role === 'admin'} // ×¨×§ Admin
  canDelete={user.role === 'admin'} // ×¨×§ Admin
  canView={true} // ×›×•×œ× ×¨×•××™× (×× ×™×© ×”×¨×©××” ×œ×”×’×™×¢ ×œ×“×£)
/>
```

---

## ğŸ”„ Data Flow ×¢× ×”×¨×©××•×ª

### 1. User logs in
```
Login â†’ Verify credentials â†’ Load user + role â†’ Store in session
```

### 2. User navigates to page
```
Route â†’ Check role â†’ Load allowed accounts â†’ Fetch data with filters
```

### 3. API call
```
Request â†’ Extract user from session â†’ Check permission â†’ Query DB with RLS â†’ Return filtered data
```

---

## ğŸ“‹ Checklist ×œ×™×™×©×•×

### Phase 1: Database
- [ ] Migration: ×˜×‘×œ×ª `users`
- [ ] Migration: ×¢×“×›×•×Ÿ RLS policies ×œ×›×œ ×”×˜×‘×œ××•×ª
- [ ] Migration: `role_permissions` (optional)
- [ ] Seed data: ×™×¦×™×¨×ª admin user ×¨××©×•×Ÿ

### Phase 2: Backend
- [ ] Auth middleware ×¢× role checking
- [ ] Permission checking functions
- [ ] API updates ×œ×›×œ endpoint
- [ ] Session management

### Phase 3: Frontend
- [ ] Login/Register pages
- [ ] RouteGuard component
- [ ] Role-based navigation
- [ ] AccountSelector (admin/agent)
- [ ] AccessDenied page

### Phase 4: Testing
- [ ] Test ×›×œ ×ª×¤×§×™×“ ×‘× ×¤×¨×“
- [ ] Test agent ×¢× 2+ ××©×¤×™×¢× ×™×
- [ ] Test permission boundaries
- [ ] Test RLS policies

---

## ğŸš¨ Security Considerations

### ×—×•×‘×•×ª:
1. âœ… **Never trust client-side** - ×ª××™×“ ×œ×‘×“×•×§ ×‘server
2. âœ… **RLS ×›×©×›×‘×” ×¨××©×•× ×”** - ×’× ×× ×™×© bug ×‘×§×•×“
3. âœ… **Audit log** - ×ª×™×¢×•×“ ×›×œ ×’×™×©×” ×œ××™×“×¢ ×¨×’×™×©
4. âœ… **Session timeout** - ×œ× ×œ×”×©××™×¨ ×¡×©×Ÿ ×¤×ª×•×— ×œ× ×¦×—
5. âœ… **2FA ×œ×× ×”×œ×™×** - Admin/Agent ×¦×¨×™×›×™× 2FA

### ××¡×•×¨×•×ª:
1. âŒ ×œ× ×œ×©××•×¨ role ×‘-localStorage (×¨×§ ×‘-session)
2. âŒ ×œ× ×œ×¡××•×š ×¢×œ query params ×œ×‘×“×™×§×ª ×”×¨×©××•×ª
3. âŒ ×œ× ×œ×—×©×•×£ account IDs ×©×œ ××—×¨×™×
4. âŒ ×œ× ×œ××¤×©×¨ elevation of privilege ×‘×§×•×“

---

## ğŸ“š Examples

### Example 1: Admin ×¨×•××” ×”×›×œ
```sql
-- Query
SELECT * FROM partnerships;

-- Result: ×›×œ ×”×©×ª"×¤×™× ×©×œ ×›×œ ×”××©×¤×™×¢× ×™×
```

### Example 2: Agent ×¨×•××” ×¨×§ ×©×œ×•
```sql
-- User: agent_id with managed_account_ids = [acc1, acc2]

SELECT * FROM partnerships 
WHERE account_id IN (
  SELECT unnest(managed_account_ids) 
  FROM users 
  WHERE id = 'agent_id'
);

-- Result: ×¨×§ ×©×ª"×¤×™× ×©×œ acc1 ×•-acc2
```

### Example 3: Influencer ×¨×•××” ×¨×§ ×©×œ×•
```sql
-- User: influencer_id with account_id = acc1

SELECT * FROM partnerships 
WHERE account_id = (
  SELECT account_id 
  FROM users 
  WHERE id = 'influencer_id'
);

-- Result: ×¨×§ ×©×ª"×¤×™× ×©×œ acc1
```

---

## ğŸ¯ Summary

**4 ×¨××•×ª ×‘×¨×•×¨×•×ª:**
1. ğŸ”´ **Admin** - ×”×›×œ
2. ğŸŸ  **Agent** - ×”××©×¤×™×¢× ×™× ×©×œ×•
3. ğŸŸ¢ **Influencer/Brand** - ×¨×§ ×©×œ×•
4. ğŸ”µ **Follower** - ×¨×§ ×¦'××˜×‘×•×˜

**3 ×©×›×‘×•×ª ××‘×˜×—×”:**
1. RLS (Database)
2. API Middleware
3. UI Route Guards

**VIEW ONLY:**
- ×œ× ×˜×¤×¡×™× ×œ×™×¦×™×¨×”
- ×¨×§ ×¦×¤×™×™×” ×•×× ×œ×™×˜×™×§×¡
- ×××©×§ ×ª××™×›×” ×œ××©×¤×™×¢×Ÿ

**×”×›×œ ××ª×•×¢×“, ×‘×¨×•×¨, ×•×××•×‘×˜×—!** ğŸ”âœ…

